<?php
/**
 * @file
 * login based on team color and game number
 * 
 * @author Chandi Cumaranatunge (chandima@asu.edu)
 */


/*********************************************************************
 DRUPAL HOOKS
*********************************************************************/

/**
 * Implements hook_block_info().
 */
function earn_it_login_tweaks_block_info() {
  $blocks['earn_it_login_form'] = array(
      'info' => t('Earn It Login'),
  );

  return $blocks;
}


/**
 * Implements hook_block_view().
 */
function earn_it_login_tweaks_block_view($delta = '') {
  switch ($delta) {
    case 'earn_it_login_form':
      $block['subject'] = t('Login');
      $block['content'] = earn_it_login_form_content();;
      break;
  }
  return $block;
}


/**
 * Implements hook_form_alter().
 */
function earn_it_login_tweaks_form_alter(&$form, &$form_state, $form_id) {
  global $user;
  switch ($form_id) {
    case 'user_profile_form':
      // Check if the user is generated and remove/modify elements
        /*if (isset($form['account']['current_pass'])) $form['account']['current_pass']['#access'] = FALSE;
        if (isset($form['account']['pass'])) $form['account']['pass']['#access'] = FALSE;*/

      break;
  }
}


/*********************************************************************
 FORMS
*********************************************************************/

function earn_it_login_form($form, &$form_state) {
  
  /*$form['team_color'] = array(
      '#type' => 'textfield',
      '#title' => t('Team Color'),
      '#size' => 8,
      '#maxlength' => 8,
      //'#required' => TRUE,
  );*/
  
  $terms = taxonomy_get_tree(5);
  $terms_select = array();
  foreach ($terms as $term) {
   $terms_select[$term->tid] = str_repeat('-', $term->depth) . $term->name;
  }
  $form['team_color'] = array(
    '#type' => 'select',
    '#title' => t('Select the term'),
    '#options' => $terms_select,
    '#required' => TRUE,
  );
  
  $form['game_number'] = array(
      '#type' => 'textfield',
      '#title' => t('Game Number'),
      '#size' => 8,
      '#maxlength' => 8,
      //'#required' => TRUE,
  );

  $form['submit'] = array(
      '#type' => 'submit',
      '#value' => 'Login',
  );
  
  $form['generate_id_description'] = array(
      '#type' => 'item',
      '#title' => t('New user? Click the button below to generate a new ID.'),
  );

  
  return $form;
}


/*********************************************************************
 CALLBACKS
*********************************************************************/

/**
 * Login form submit function
 *   Login or register user
 * @param array $form
 * @param array $form_state
 */
function earn_it_login_form_submit($form, &$form_state) {
  if (isset($form_state['values']['op'])) {
    switch ($form_state['values']['op']) {
      
      
     case 'Login':
      //validation has already checked that this is a valid user
       if (isset($form_state['values']['team_color']) && $form_state['values']['team_color'] && isset($form_state['values']['game_number']) && $form_state['values']['game_number']) {
         global $user;
         $user = user_load_by_name($form_state['values']['game_number'].$form_state['values']['team_color']);
         drupal_session_regenerate();
         drupal_goto('user/'.$user->uid);
       }
      break;
    }
  }
}


/**
 * PGI Login form validation
 *   Checks if ID code valid if Login
 * @param array $form
 * @param array $form_state
 */
function earn_it_login_form_validate($form, &$form_state) {
  if (isset($form_state['values']['op'])) {
    switch ($form_state['values']['op']) {
      case 'Login':
        if (isset($form_state['values']['team_color']) && $form_state['values']['team_color'] && isset($form_state['values']['game_number']) && $form_state['values']['game_number']) {
             return true;
        } else {
          form_set_error('id_code', t('Team color and game name required.'));
        }
        break;
      }
   }
}


/*********************************************************************
 UTILITY
*********************************************************************/


/**
 * Custom ID based login form
 * @return string
 */
function earn_it_login_form_content() {
  $html = '';
  $html .= drupal_render(drupal_get_form('earn_it_login_form'));
  return $html;
}
